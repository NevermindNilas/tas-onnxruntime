name: Build ONNX Runtime Dual EP

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch:
    inputs:
      ort_version:
        description: 'ONNX Runtime version to build (e.g., v1.20.1)'
        required: false
        default: ''

jobs:
  check_version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      ort_version: ${{ steps.compare.outputs.ort_version }}
    steps:
      - name: Compare Versions
        id: compare
        run: |
          # Get latest release from microsoft/onnxruntime
          LATEST_ORT=$(curl -s https://api.github.com/repos/microsoft/onnxruntime/releases/latest | jq -r .tag_name)
          
          # If manual version provided, use it
          if [ "${{ github.event.inputs.ort_version }}" != "" ]; then
            LATEST_ORT="${{ github.event.inputs.ort_version }}"
          fi
          
          # Get latest release from current repo
          # Note: If no releases exist, this might fail or return null. Handle it.
          CURRENT_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "none")
          
          echo "Latest ORT available: $LATEST_ORT"
          echo "Current repository release: $CURRENT_RELEASE"
          
          if [ "$LATEST_ORT" != "$CURRENT_RELEASE" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ort_version=$LATEST_ORT" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build_windows:
    needs: check_version
    if: needs.check_version.outputs.should_build == 'true'
    runs-on: windows-2022
    steps:
      - name: Checkout ORT
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: ${{ needs.check_version.outputs.ort_version }}
          submodules: recursive
          path: onnxruntime

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel numpy==2.3.5 openvino==2025.4.1 flatbuffers packaging protobuf sympy mpmath humanfriendly pyreadline3 coloredlogs

      - name: Build Windows Wheel
        shell: pwsh
        run: |
          # Logic from run_build.py
          $ov_path = python -c "import openvino; import os; print(os.path.dirname(openvino.__file__))"
          $env:OpenVINO_DIR = Join-Path $ov_path "cmake"
          $env:PATH = "$(Join-Path $ov_path "libs");" + $env:PATH
          
          python onnxruntime/tools/ci_build/build.py `
            --build_dir build `
            --config Release `
            --build_wheel `
            --use_openvino CPU `
            --use_dml `
            --parallel `
            --skip_tests `
            --compile_no_warning_as_error

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-windows-wheel
          path: build/Release/Release/dist/*.whl

  build_linux:
    needs: check_version
    if: needs.check_version.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout ORT
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: ${{ needs.check_version.outputs.ort_version }}
          submodules: recursive
          path: onnxruntime

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install wheel numpy==2.3.5 openvino==2025.4.1 flatbuffers packaging protobuf sympy mpmath humanfriendly coloredlogs

      - name: Build Linux Wheel
        run: |
          # Logic from run_build.py adapted for Linux
          export OpenVINO_DIR=$(python3 -c "import openvino; import os; print(os.path.join(os.path.dirname(openvino.__file__), 'cmake'))")
          
          python3 onnxruntime/tools/ci_build/build.py \
            --build_dir build \
            --config Release \
            --build_wheel \
            --use_openvino CPU \
            --parallel \
            --skip_tests \
            --compile_no_warning_as_error

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-linux-wheel
          path: build/Release/dist/*.whl

  create_release:
    needs: [check_version, build_windows, build_linux]
    if: needs.check_version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows Wheel
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-windows-wheel
          path: dist

      - name: Download Linux Wheel
        uses: actions/download-artifact@v4
        with:
          name: onnxruntime-linux-wheel
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check_version.outputs.ort_version }}
          name: ONNX Runtime ${{ needs.check_version.outputs.ort_version }} (Dual EP)
          files: dist/*.whl
          body: |
            Automated build of ONNX Runtime with dual Execution Providers.
            - **Windows**: OpenVINO + DirectML
            - **Linux**: OpenVINO
            - **Python**: 3.13
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
